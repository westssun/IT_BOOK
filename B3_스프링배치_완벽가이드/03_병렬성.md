잡을 병렬화 하는 방법

1) 다중 스레드 스텝을 통한 작업 분할

스프링 배치에서 잡은 청크(chunk) 라는 블록 단위로 처리되도록 구성되며, 각 청크는 각자 독립적인 트랜잭션에서 처리된다.

일반적으로 각 청크는 연속해서 처리된다.

10,000개의 레코드가 있을때 커밋수를 50개로 했다면 1~50, 51~100 과정으로 처리하고 커밋하고 10,000개를 모두 처리될때까지 반복한다.

스프링배치를 사용하면 작업을 병렬로 실행할 수 있따.

스텝1 → 스텝2[청크1, 청크2, 청크3] →  스텝3

2) 전체 스텝의 병렬 실행

입력 파일의 데이터를 읽어오는 한개의 스텝과 데이터베이스에 저장하는 일을 하는 한개의 스텝이 있지만 서로 관련이 없을 경우, 병렬 스텝 처리 기능으로 처리할 수 있다.

3) 비동기 ItemProcessor/ItemWriter

SynchonousItemProcessor 는 ItemProcessor 가 호출될때마다 동일한 스레드에서 실행하게 만들어주는, ItemProcessor 구현체의 데코레이터다.

AsynchronousItemPRocessor는 ItemProcessor 호출 결과를 반환하는 대신 각 호출에 대해 Future 을 반환한다. 현재 청크 내에서 반환된 Future 목록은 AsynchronousItemWriter 로 전달된다.

AsynchronousItemWriter 는 이 상황에서 스텝 내에서 실제로 사용해야하는 ItemWriter의 데코레이터인데, Future 을 이용해 실제 결과를 얻어낸 후 이를 위임한 ItemWriter에 전달한다.

4) 원격 청킹

입력은 마스터 노드에서 표준 ItemReader 를 사용하여 이뤄진다.

그런다음, 입력은 지속 가능한 통신 형식을 통해 메시지 기반 POJO로 구성된 원격 워커 ItemProcessor 로 전송된다. (rabbitMQ, activeMQ 와 같은 메시지 브로커)

처리가 완료되면 워커는 업데이트된 아이템을 다시 마스터로 보내거나 직접 기록한다.

이 방법은 마스터에서 데이터를 읽고 원격 워커에서 처리한 다음 다시 마스터에게 전송하므로 네트워크 사용량이 많아질 수 있다.

5) 파티셔닝

스프링 배치는 원격 파티셔닝, 로컬 파티셔닝을 모두 지원한다.

원격 파티셔닝 : 마스터 및 원격 워커를 사용

로컬 파티셔닝 : 워커의 스레드를 사용

원격 파티셔닝을 사용하면 내구성이 있는 통신 방법이 필요하지 않으며, 마스터는 워커의 스텝 수집을 위한 컨트롤러 역할만 한다.

이 경우 각 워커의 스텝은 독립적으로 동작하며 마치 로컬로 배포된 것처럼 동일하게 구성된다.

유일한 차이점은 워커의 스텝이 자신의 잡 대신 마스터 노드로부터 일을 전달받는다는 점이다.

모든 워커가 각각 맡은 일을 완료하면 마스터 스텝이 완료된 것으로 간주한다.

JobRepository 가 분산된 작업의 상태를 알지못하는 원격 청킹 방식과 다르게, JpaRepository가 복제된 작업이 없고 모든 작업이 완료됐음을 보장하기 때문에 내구성 있는 지속적인 통신이 필요없다.